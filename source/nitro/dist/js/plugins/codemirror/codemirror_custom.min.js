/*
* Plugin:  Codemirror Plugin
* Version: 1.0.0 (20.08.2018.)
*
* Author:  Marko Goricki, BiLog
* Mail:    mgoricki@gmail.com
* Twitter: @mgoricki
* Blog:    apexbyg.blogspot.com 
*
* Depends:
*    apex/debug.js
*
* Changes:
*
* v.1.0.0 - 20180820 - Initial version
*
* Public Methods:
*
*   Get Options
*   $('#P6_DEPTNO').master_detail_item('option');
*
*   Get Selected Row Data
*   $('#P6_DEPTNO').master_detail_item('getSelectedRowData');
*
* Notes:
*   - 
*
*/
!function(r,n){"use strict";r.widget("apex.codemirror_plugin",{options:{itemName:null,readonly:!1,ignoreChanged:!1,ajaxId:null,autocomplete:!1},changed:!1,baseId:"aCodeMirrorPlugin",_init:function(){var n=this;n.baseId=n.options.itemName,n._editor=CodeMirror.fromTextArea(document.getElementById(n.options.itemName),{mode:"text/x-plsql",indentWithTabs:!0,martIndent:!0,lineNumbers:!0,matchBrackets:!0,textWrapping:!1,autofocus:!1,indentUnit:2,smartIndent:!0,tabSize:2,viewportMargin:5,readOnly:n.options.readonly,extraKeys:{"Ctrl-Space":"autocomplete",F11:function(e){e.setOption("fullScreen",!e.getOption("fullScreen"))},Esc:function(e){e.getOption("fullScreen")&&e.setOption("fullScreen",!1)}},autoCloseBrackets:!0}),n.options.ignoreChanged||n._editor.on("change",function(){n.changed=!0;var e=n._editor.historySize();r("#"+n.baseId+"_undo")[0].disabled=0===e.undo,r("#"+n.baseId+"_redo")[0].disabled=0===e.redo}),n._initToolbar(),n._editor.isReadOnly()&&n.element.closest(".codemirror-wrapper").addClass("codemirror-readonly"),n.options.autocomplete&&(CodeMirror.commands.autocomplete=function(e){var t,o={};switch(e.doc.modeOption){case"text/javascript":t=CodeMirror.hint.javascript;break;case"text/css":t=CodeMirror.hint.css;break;case"text/html":t=CodeMirror.hint.html;break;case"text/x-plsql":t=customHint,o={async:!0,dataCallback:function(e,t){apex.server.plugin(n.options.ajaxId,{x01:"hint",x02:e.search,x03:e.parent,x04:e.grantParent},{success:t})}}}t&&CodeMirror.showHint(e,t,o)}),apex.item.create(n.options.itemName,{getValidity:function(){return{valid:!0}},getValue:function(){return apex.debug.log("CodeMirror Plugin","getValue"),n._editor.doc.getValue()},setValue:function(e){apex.debug.log("CodeMirror Plugin","setValue"),n._editor.doc.setValue(e)},disable:function(){apex.debug.log("CodeMirror Plugin","Not implemented")},enable:function(){apex.debug.log("CodeMirror Plugin","Not implemented")},show:function(){apex.debug.log("CodeMirror Plugin","Not implemented")},hide:function(){apex.debug.log("CodeMirror Plugin","Not implemented")},isChanged:function(){return n.changed}})},_log:function(e,t){apex.debug.log("Code Mirror",e,t)},_destroy:function(){this._editor.off("change")},_renderButton:function(e,t,o,n,r,i){e.markup("<button").attr("id",this.baseId+"_"+t).optionalAttr("title",o).optionalAttr("aria-label",o).optionalBoolAttr("disabled",i).attr("class","a-Button a-Button--noLabel a-Button--withIcon"+(r?" "+r:"")).markup(" type='button'>").markup("<span class='a-Icon ").attr(n).markup("' aria-hidden='true'></span></button>")},_initToolbar:function(){var t=this,e=n.htmlBuilder();function o(e){r(document).on("click","#"+t.baseId+"_"+e,function(){if(t._editor)switch(t._editor.focus(),e){case"fullScreenOn":t._editor.setOption("fullScreen",!t._editor.getOption("fullScreen"));break;case"fullScreenOff":t._editor.getOption("fullScreen")&&t._editor.setOption("fullScreen",!1);break;default:setTimeout(function(){t._editor.execCommand(e)},10)}})}e.markup('<div class="codemirror-toolbar">'),t.options.readonly||(t._renderButton(e,"undo","Undo","icon-undo","a-Button--small a-Button--pillStart",!0),t._renderButton(e,"redo","Redo","icon-redo","a-Button--small a-Button--pill",!0),o("undo"),o("redo")),t._renderButton(e,"fullScreenOn","Full Screen On","icon-maximize","a-Button--small a-Button--pillEnd aCodeMirrorPluginFullScreenOn u-pullRight"),t._renderButton(e,"fullScreenOff","Full Screen Off","icon-restore","a-Button--small a-Button--pillEnd aCodeMirrorPluginFullScreenOff u-pullRight"),e.markup("</div>"),o("fullScreenOn"),o("fullScreenOff"),t.element.after(e.toString()),t.element.closest("div").addClass("codemirror-wrapper"),t.element.closest("div.t-Form-fieldContainer").addClass("codemirror-container-wrapper")}})}(apex.jQuery,apex.util);
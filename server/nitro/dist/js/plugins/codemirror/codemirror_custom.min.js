/*
* Plugin:  Codemirror Plugin
* Version: 1.0.0 (20.08.2018.)
*
* Author:  Marko Goricki, BiLog
* Mail:    mgoricki@gmail.com
* Twitter: @mgoricki
* Blog:    apexbyg.blogspot.com 
*
* Depends:
*    apex/debug.js
*
* Changes:
*
* v.1.0.0 - 20180820 - Initial version
*
* Public Methods:
*
*   Get Options
*   $('#P6_DEPTNO').master_detail_item('option');
*
*   Get Selected Row Data
*   $('#P6_DEPTNO').master_detail_item('getSelectedRowData');
*
* Notes:
*   - 
*
*/
!function(e,t){"use strict";e.widget("apex.codemirror_plugin",{options:{itemName:null,readonly:!1,ignoreChanged:!1,ajaxId:null,autocomplete:!1,runInFullscreen:!1},changed:!1,baseId:"aCodeMirrorPlugin",_init:function(){var t=this;t.baseId=t.options.itemName,t._editor=CodeMirror.fromTextArea(document.getElementById(t.options.itemName),{mode:"text/x-plsql",indentWithTabs:!0,martIndent:!0,lineNumbers:!0,matchBrackets:!0,textWrapping:!1,autofocus:!1,indentUnit:2,smartIndent:!0,tabSize:2,viewportMargin:5,readOnly:t.options.readonly,extraKeys:{"Ctrl-Space":"autocomplete",F11:function(e){e.setOption("fullScreen",!e.getOption("fullScreen"))},Esc:function(e){e.getOption("fullScreen")&&e.setOption("fullScreen",!1)}},autoCloseBrackets:!0}),t.options.ignoreChanged||t._editor.on("change",function(){t.changed=!0;var o=t._editor.historySize();e("#"+t.baseId+"_undo")[0].disabled=0===o.undo,e("#"+t.baseId+"_redo")[0].disabled=0===o.redo}),t._initToolbar(),t.options.runInFullscreen&&t._editor.setOption("fullScreen",!0),t._editor.isReadOnly()&&t.element.closest(".codemirror-wrapper").addClass("codemirror-readonly"),t.options.autocomplete&&(CodeMirror.commands.autocomplete=function(e){var o,r={};switch(e.doc.modeOption){case"text/javascript":o=CodeMirror.hint.javascript;break;case"text/css":o=CodeMirror.hint.css;break;case"text/html":o=CodeMirror.hint.html;break;case"text/x-plsql":o=customHint,r={async:!0,dataCallback:function(e,o){apex.server.plugin(t.options.ajaxId,{x01:"hint",x02:e.search,x03:e.parent,x04:e.grantParent},{success:o})}}}o&&CodeMirror.showHint(e,o,r)}),apex.item.create(t.options.itemName,{getValidity:function(){return{valid:!0}},getValue:function(){return apex.debug.log("CodeMirror Plugin","getValue"),t._editor.doc.getValue()},setValue:function(e){apex.debug.log("CodeMirror Plugin","setValue"),t._editor.doc.setValue(e)},disable:function(){t._disable()},enable:function(){t._enable()},show:function(){apex.debug.log("CodeMirror Plugin","Not implemented")},hide:function(){apex.debug.log("CodeMirror Plugin","Not implemented")},isChanged:function(){return t.changed}})},_log:function(e,t){apex.debug.log("Code Mirror",e,t)},_destroy:function(){this._editor.off("change")},_renderButton:function(e,t,o,r,n,i){e.markup("<button").attr("id",this.baseId+"_"+t).optionalAttr("title",o).optionalAttr("aria-label",o).optionalBoolAttr("disabled",i).attr("class","a-Button a-Button--noLabel a-Button--withIcon"+(n?" "+n:"")).markup(" type='button'>").markup("<span class='a-Icon ").attr(r).markup("' aria-hidden='true'></span></button>")},_initToolbar:function(){var o=this,r=t.htmlBuilder();function n(t){e(document).on("click","#"+o.baseId+"_"+t,function(){if(o._editor)switch(o._editor.focus(),t){case"fullScreenOn":o._editor.setOption("fullScreen",!o._editor.getOption("fullScreen"));break;case"fullScreenOff":o._editor.getOption("fullScreen")&&o._editor.setOption("fullScreen",!1);break;default:setTimeout(function(){o._editor.execCommand(t)},10)}})}r.markup('<div class="codemirror-toolbar">'),o.options.readonly||(o._renderButton(r,"undo","Undo","icon-undo","a-Button--small a-Button--pillStart",!0),o._renderButton(r,"redo","Redo","icon-redo","a-Button--small a-Button--pill",!0),n("undo"),n("redo")),o._renderButton(r,"fullScreenOn","Full Screen On","icon-maximize","a-Button--small a-Button--pillEnd aCodeMirrorPluginFullScreenOn u-pullRight"),o._renderButton(r,"fullScreenOff","Full Screen Off","icon-restore","a-Button--small a-Button--pillEnd aCodeMirrorPluginFullScreenOff u-pullRight"),r.markup("</div>"),n("fullScreenOn"),n("fullScreenOff"),o.element.after(r.toString()),o.element.closest("div").addClass("codemirror-wrapper"),o.element.closest("div.t-Form-fieldContainer").addClass("codemirror-container-wrapper")},_enable:function(){apex.debug.log("Code Mirror Editor","_enable"),this._editor.setOption("readOnly",!1);var e=this.element.closest(".codemirror-wrapper");e.removeClass("codemirror-readonly"),e.find(".codemirror-toolbar > button[id$=undo]").prop("disabled",!1),e.find(".codemirror-toolbar > button[id$=redo]").prop("disabled",!1)},_disable:function(){apex.debug.log("Code Mirror Editor","_disable"),this._editor.setOption("readOnly",!0);var e=this.element.closest(".codemirror-wrapper");e.addClass("codemirror-readonly"),e.find(".codemirror-toolbar > button[id$=undo]").prop("disabled",!0),e.find(".codemirror-toolbar > button[id$=redo]").prop("disabled",!0)}})}(apex.jQuery,apex.util);
/*
* Plugin:  Codemirror Plugin
* Version: 1.0.0 (20.08.2018.)
*
* Author:  Marko Goricki, BiLog
* Mail:    mgoricki@gmail.com
* Twitter: @mgoricki
* Blog:    apexbyg.blogspot.com 
*
* Depends:
*    apex/debug.js 
*
* Changes:
* 
* v.1.0.4 - 20211123 - upgraded to CodeMirror 5.64.0, APEX version 21.2
* v.1.0.3 - 20191009 - setHeight and setWidth
* v.1.0.0 - 20180820 - Initial version
*
* Public Methods:
*
*   Get Options
*   $('#P2_EDITOR').codemirror_plugin('option');
*
*   Set Height
*   apex.item('P2_EDITOR').callbacks.setHeight('auto');
*   apex.item('P2_EDITOR').callbacks.setHeight('600'); -- in px
*   apex.item('P2_EDITOR').callbacks.setHeight('100%'); -- in %
*
* Notes:
*   - 
*
*/
!function(e,t){"use strict";e.widget("apex.codemirror_plugin",{options:{itemName:null,readonly:!1,ignoreChanged:!1,ajaxId:null,autocomplete:!1,runInFullscreen:!1,autocompleteHints:[],config:{}},changed:!1,baseId:"aCodeMirrorPlugin",_returnAutocompleteOptions:function(e,t){var o=t.autocompleteHints;return new Promise(function(t){setTimeout(function(){for(var r=e.getCursor(),n=e.getLine(r.line),i=r.ch,l=r.ch;i&&/\w/.test(n.charAt(i-1));)--i;for(;l<n.length&&/\w/.test(n.charAt(l));)++l;var a=n.slice(i,l).toLowerCase(),d=o.filter(function(e,t,o){var r=e.text.toLowerCase(),n=r.substr(r.indexOf("$")+1);return r.startsWith(a)||n.startsWith(a)});return d.length>0?t({list:d,from:CodeMirror.Pos(r.line,i),to:CodeMirror.Pos(r.line,l)}):t(null)},100)})},_init:function(){var t=this;t.baseId=t.options.itemName,e.extend(t.options,t.options.config),t._editor=CodeMirror.fromTextArea(document.getElementById(t.options.itemName),{mode:"text/x-plsql",indentWithTabs:!0,martIndent:!0,lineNumbers:!0,matchBrackets:!0,textWrapping:!1,autofocus:!1,indentUnit:2,smartIndent:!0,tabSize:2,viewportMargin:5,readOnly:t.options.readonly,extraKeys:{"Ctrl-Space":"autocomplete",F11:function(e){e.setOption("fullScreen",!e.getOption("fullScreen"))},Esc:function(e){e.getOption("fullScreen")&&e.setOption("fullScreen",!1)}},autoCloseBrackets:!0}),t.options.ignoreChanged||t._editor.on("change",function(){t.changed=!0;var o=t._editor.historySize();e("#"+t.baseId+"_undo")[0].disabled=0===o.undo,e("#"+t.baseId+"_redo")[0].disabled=0===o.redo}),t._initToolbar(),t.options.runInFullscreen&&t._editor.setOption("fullScreen",!0),t._editor.isReadOnly()&&t.element.closest(".codemirror-wrapper").addClass("codemirror-readonly"),t.options.autocomplete&&(CodeMirror.commands.autocomplete=function(e){var o,r={};switch(e.doc.modeOption){case"text/javascript":o=CodeMirror.hint.javascript;break;case"text/css":o=CodeMirror.hint.css;break;case"text/html":o=CodeMirror.hint.html;break;case"text/x-plsql":o=t._returnAutocompleteOptions,r.autocompleteHints=t.options.autocompleteHints}o&&CodeMirror.showHint(e,o,r)}),apex.item.create(t.options.itemName,{getValidity:function(){return{valid:!0}},getValue:function(){return apex.debug.log("CodeMirror Plugin","getValue"),t._editor.doc.getValue()},setValue:function(e){apex.debug.log("CodeMirror Plugin","setValue"),t._editor.doc.setValue(e)},disable:function(){t._disable()},enable:function(){t._enable()},show:function(){apex.debug.log("CodeMirror Plugin","Not implemented")},hide:function(){apex.debug.log("CodeMirror Plugin","Not implemented")},isChanged:function(){return t.changed},setHeight:function(e){t._editor.setSize(null,e)},setWidth:function(e){t._editor.setSize(e,null)}})},_log:function(e,t){apex.debug.log("Code Mirror",e,t)},_destroy:function(){this._editor.off("change")},_renderButton:function(e,t,o,r,n,i){e.markup("<button").attr("id",this.baseId+"_"+t).optionalAttr("title",o).optionalAttr("aria-label",o).optionalBoolAttr("disabled",i).attr("class","a-Button a-Button--noLabel a-Button--withIcon"+(n?" "+n:"")).markup(" type='button'>").markup("<span class='a-Icon ").attr(r).markup("' aria-hidden='true'></span></button>")},_initToolbar:function(){var o=this,r=t.htmlBuilder();function n(t){e(document).on("click","#"+o.baseId+"_"+t,function(){if(o._editor)switch(o._editor.focus(),t){case"fullScreenOn":o._editor.setOption("fullScreen",!o._editor.getOption("fullScreen"));break;case"fullScreenOff":o._editor.getOption("fullScreen")&&o._editor.setOption("fullScreen",!1);break;default:setTimeout(function(){o._editor.execCommand(t)},10)}})}r.markup('<div class="codemirror-toolbar">'),o.options.readonly||(o._renderButton(r,"undo","Undo","icon-undo","a-Button--small a-Button--pillStart",!0),o._renderButton(r,"redo","Redo","icon-redo","a-Button--small a-Button--pill",!0),n("undo"),n("redo")),o._renderButton(r,"fullScreenOn","Full Screen On","icon-maximize","a-Button--small a-Button--pillEnd aCodeMirrorPluginFullScreenOn u-pullRight"),o._renderButton(r,"fullScreenOff","Full Screen Off","icon-restore","a-Button--small a-Button--pillEnd aCodeMirrorPluginFullScreenOff u-pullRight"),r.markup("</div>"),n("fullScreenOn"),n("fullScreenOff"),o.element.after(r.toString()),o.element.closest("div").addClass("codemirror-wrapper"),o.element.closest("div.t-Form-fieldContainer").addClass("codemirror-container-wrapper")},_enable:function(){apex.debug.log("Code Mirror Editor","_enable"),this._editor.setOption("readOnly",!1);var e=this.element.closest(".codemirror-wrapper");e.removeClass("codemirror-readonly"),e.find(".codemirror-toolbar > button[id$=undo]").prop("disabled",!1),e.find(".codemirror-toolbar > button[id$=redo]").prop("disabled",!1)},_disable:function(){apex.debug.log("Code Mirror Editor","_disable"),this._editor.setOption("readOnly",!0);var e=this.element.closest(".codemirror-wrapper");e.addClass("codemirror-readonly"),e.find(".codemirror-toolbar > button[id$=undo]").prop("disabled",!0),e.find(".codemirror-toolbar > button[id$=redo]").prop("disabled",!0)}})}(apex.jQuery,apex.util),
// CodeMirror, copyright (c) by Marijn Haverbeke and others
// Distributed under an MIT license: http://codemirror.net/LICENSE
function(e){"object"==typeof exports&&"object"==typeof module?e(require("../../lib/codemirror")):"function"==typeof define&&define.amd?define(["../../lib/codemirror"],e):e(CodeMirror)}(function(e){"use strict";e.defineOption("fullScreen",!1,function(t,o,r){r==e.Init&&(r=!1),!r!=!o&&(o?function(e){var t=e.getWrapperElement();$(t).closest("div.codemirror-wrapper").addClass("codemirror-wrapp-fullscreen"),e.state.fullScreenRestore={scrollTop:window.pageYOffset,scrollLeft:window.pageXOffset,width:t.style.width,height:t.style.height},t.style.width="",t.style.height="auto",t.className+=" CodeMirror-fullscreen",document.documentElement.style.overflow="hidden",e.refresh()}(t):function(e){var t=e.getWrapperElement();$(t).closest("div.codemirror-wrapper").removeClass("codemirror-wrapp-fullscreen"),t.className=t.className.replace(/\s*CodeMirror-fullscreen\b/,""),document.documentElement.style.overflow="";var o=e.state.fullScreenRestore;t.style.width=o.width,t.style.height=o.height,window.scrollTo(o.scrollLeft,o.scrollTop),e.refresh()}(t))})});
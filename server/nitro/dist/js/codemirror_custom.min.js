/*
* Plugin:  Codemirror Plugin
* Version: 1.0.0 (20.08.2018.)
*
* Author:  Marko Goricki, BiLog
* Mail:    mgoricki@gmail.com
* Twitter: @mgoricki
* Blog:    apexbyg.blogspot.com 
*
* Depends:
*    apex/debug.js 
*
* Changes:
* 
* v.1.0.5 - 20211202 - Validate Code option
* v.1.0.4 - 20211123 - upgraded to CodeMirror 5.64.0, APEX version 21.2
* v.1.0.3 - 20191009 - setHeight and setWidth
* v.1.0.0 - 20180820 - Initial version
*
* Public Methods:
*
*   Get Options
*   $('#P2_EDITOR').codemirror_plugin('option');
*
*   Set Height
*   apex.item('P2_EDITOR').callbacks.setHeight('auto');
*   apex.item('P2_EDITOR').callbacks.setHeight('600'); -- in px
*   apex.item('P2_EDITOR').callbacks.setHeight('100%'); -- in %
*
* Notes:
*   - 
*
*/
!function(e,t,o){"use strict";e.widget("apex.codemirror_plugin",{options:{itemName:null,readonly:!1,ignoreChanged:!1,ajaxId:null,autocomplete:!1,runInFullscreen:!1,autocompleteHints:[],validateCode:!1,config:{}},_privateStorage:function(){this._obj={wrapper$:null}},changed:!1,baseId:"aCodeMirrorPlugin",_log:function(e,t){Array.prototype.unshift.call(arguments,"codemirror_custom.js"),o.apply(o.log,arguments)},_returnAutocompleteOptions:function(e,t){var o=t.autocompleteHints;return new Promise(function(t){setTimeout(function(){for(var r=e.getCursor(),i=e.getLine(r.line),n=r.ch,l=r.ch;n&&/\w/.test(i.charAt(n-1));)--n;for(;l<i.length&&/\w/.test(i.charAt(l));)++l;var a=i.slice(n,l).toLowerCase(),d=o.filter(function(e,t,o){var r=e.text.toLowerCase(),i=r.substr(r.indexOf("$")+1);return 0==r.indexOf(":")&&(r=r.substr(r.indexOf(":")+1)),r.startsWith(a)||i.startsWith(a)});return d.length>0?t({list:d,from:CodeMirror.Pos(r.line,n),to:CodeMirror.Pos(r.line,l)}):t(null)},100)})},_init:function(){var t=this;t._privateStorage(),t.baseId=t.options.itemName,e.extend(t.options,t.options.config),t._editor=CodeMirror.fromTextArea(document.getElementById(t.options.itemName),{mode:"text/x-plsql",indentWithTabs:!0,martIndent:!0,lineNumbers:!0,matchBrackets:!0,textWrapping:!1,autofocus:!1,indentUnit:2,smartIndent:!0,tabSize:2,viewportMargin:5,readOnly:t.options.readonly,extraKeys:{"Ctrl-Space":"autocomplete",F11:function(e){e.setOption("fullScreen",!e.getOption("fullScreen"))},Esc:function(e){e.getOption("fullScreen")&&e.setOption("fullScreen",!1)},"Ctrl-Alt-V":function(){t._validateCode()}},autoCloseBrackets:!0}),t.options.ignoreChanged||t._editor.on("change",function(){t.changed=!0;var o=t._editor.historySize();e("#"+t.baseId+"_undo")[0].disabled=0===o.undo,e("#"+t.baseId+"_redo")[0].disabled=0===o.redo}),t._initToolbar(),t.options.validateCode&&t._obj.wrapper$.on("click",".codemirror-msg-close",function(){var t=e(this),o=t.closest(".codemirror-msg-box");1==o.children().length?o.remove():t.closest(".codemirror-msg").remove()}),t.options.runInFullscreen&&t._editor.setOption("fullScreen",!0),t._editor.isReadOnly()&&t.element.closest(".codemirror-wrapper").addClass("codemirror-readonly"),t.options.autocomplete&&(CodeMirror.commands.autocomplete=function(e){var o,r={};switch(e.doc.modeOption){case"text/javascript":o=CodeMirror.hint.javascript;break;case"text/css":o=CodeMirror.hint.css;break;case"text/html":o=CodeMirror.hint.html;break;case"text/x-plsql":o=t._returnAutocompleteOptions,r.autocompleteHints=t.options.autocompleteHints}o&&CodeMirror.showHint(e,o,r)}),apex.item.create(t.options.itemName,{getValidity:function(){return{valid:!0}},getValue:function(){return t._log("CodeMirror Plugin","getValue"),t._editor.doc.getValue()},setValue:function(e){t._log("CodeMirror Plugin","setValue"),t._editor.doc.setValue(e)},disable:function(){t._disable()},enable:function(){t._enable()},show:function(){t._log("CodeMirror Plugin","Not implemented")},hide:function(){t._log("CodeMirror Plugin","Not implemented")},isChanged:function(){return t.changed},setHeight:function(e){t._editor.setSize(null,e)},setWidth:function(e){t._editor.setSize(e,null)}})},_destroy:function(){this._editor.off("change")},_renderButton:function(e,t,o,r,i,n){e.markup("<button").attr("id",this.baseId+"_"+t).optionalAttr("title",o).optionalAttr("aria-label",o).optionalBoolAttr("disabled",n).attr("class","a-Button a-Button--noLabel a-Button--withIcon"+(i?" "+i:"")).markup(" type='button'>").markup("<span class='a-Icon ").attr(r).markup("' aria-hidden='true'></span></button>")},_validateCode:function(){var e=this;e._log("_validateCode",arguments);var t=e._obj.wrapper$.find(".codemirror-toolbar > button[id$=validate]");t.prop("disabled",!0),e._obj.wrapper$.find(".codemirror-msg-box").remove();apex.server.plugin(e.options.ajaxId,{x01:"VALIDATE",x02:e._editor.doc.getValue()},{success:function(o){if(o.msgType){t.prop("disabled",!1),e._obj.wrapper$.find(".codemirror-toolbar").after('<div class="codemirror-msg-box"><div class="codemirror-msg codemirror-msg-type-'+o.msgType+'"><div class="msg-text">'+o.msg+'</div><button type="button" title="Close" aria-label="My Button" class="codemirror-msg-close t-Button t-Button--noLabel t-Button--icon t-Button--small"><span aria-hidden="true" class="t-Icon fa fa-times"></span></button></div></div>');e._obj.wrapper$.find(".codemirror-msg").delay(3e3).fadeOut("slow")}}})},_initToolbar:function(){var o=this,r=t.htmlBuilder();function i(t){e(document).on("click","#"+o.baseId+"_"+t,function(){if(o._editor)switch(o._editor.focus(),t){case"fullScreenOn":o._editor.setOption("fullScreen",!o._editor.getOption("fullScreen"));break;case"fullScreenOff":o._editor.getOption("fullScreen")&&o._editor.setOption("fullScreen",!1);break;case"validate":o._validateCode();break;default:setTimeout(function(){o._editor.execCommand(t)},10)}})}r.markup('<div class="codemirror-toolbar">'),o.options.readonly||(o._renderButton(r,"undo","Undo","icon-undo","a-Button--small a-Button--pillStart",!0),o._renderButton(r,"redo","Redo","icon-redo","a-Button--small a-Button--pill",!0),i("undo"),i("redo")),o.options.validateCode&&(o._renderButton(r,"validate","Validate Code (Ctrl+Alt+V)","icon-check","a-Button--small a-Button--pillStart"),i("validate")),o._renderButton(r,"fullScreenOn","Full Screen On (F11)","icon-maximize","a-Button--small a-Button--pillEnd aCodeMirrorPluginFullScreenOn u-pullRight"),o._renderButton(r,"fullScreenOff","Full Screen Off (Esc)","icon-restore","a-Button--small a-Button--pillEnd aCodeMirrorPluginFullScreenOff u-pullRight"),r.markup("</div>"),i("fullScreenOn"),i("fullScreenOff"),o.element.after(r.toString()),o.element.closest("div").addClass("codemirror-wrapper"),o.element.closest("div.t-Form-fieldContainer").addClass("codemirror-container-wrapper"),o._obj.wrapper$=e(o.element).closest(".codemirror-wrapper")},_enable:function(){this._log("Code Mirror Editor","_enable"),this._editor.setOption("readOnly",!1),this._obj.wrapper$.removeClass("codemirror-readonly"),this._obj.wrapper$.find(".codemirror-toolbar > button[id$=undo]").prop("disabled",!1),this._obj.wrapper$.find(".codemirror-toolbar > button[id$=redo]").prop("disabled",!1),this._obj.wrapper$.find(".codemirror-toolbar > button[id$=validate]").prop("disabled",!1)},_disable:function(){this._log("Code Mirror Editor","_disable"),this._editor.setOption("readOnly",!0),this._obj.wrapper$.addClass("codemirror-readonly"),this._obj.wrapper$.find(".codemirror-toolbar > button[id$=undo]").prop("disabled",!0),this._obj.wrapper$.find(".codemirror-toolbar > button[id$=redo]").prop("disabled",!0),this._obj.wrapper$.find(".codemirror-toolbar > button[id$=validate]").prop("disabled",!0)}})}(apex.jQuery,apex.util,apex.debug),
// CodeMirror, copyright (c) by Marijn Haverbeke and others
// Distributed under an MIT license: http://codemirror.net/LICENSE
function(e){"object"==typeof exports&&"object"==typeof module?e(require("../../lib/codemirror")):"function"==typeof define&&define.amd?define(["../../lib/codemirror"],e):e(CodeMirror)}(function(e){"use strict";e.defineOption("fullScreen",!1,function(t,o,r){r==e.Init&&(r=!1),!r!=!o&&(o?function(e){var t=e.getWrapperElement();$(t).closest("div.codemirror-wrapper").addClass("codemirror-wrapp-fullscreen"),e.state.fullScreenRestore={scrollTop:window.pageYOffset,scrollLeft:window.pageXOffset,width:t.style.width,height:t.style.height},t.style.width="",t.style.height="auto",t.className+=" CodeMirror-fullscreen",document.documentElement.style.overflow="hidden",e.refresh()}(t):function(e){var t=e.getWrapperElement();$(t).closest("div.codemirror-wrapper").removeClass("codemirror-wrapp-fullscreen"),t.className=t.className.replace(/\s*CodeMirror-fullscreen\b/,""),document.documentElement.style.overflow="";var o=e.state.fullScreenRestore;t.style.width=o.width,t.style.height=o.height,window.scrollTo(o.scrollLeft,o.scrollTop),e.refresh()}(t))})});